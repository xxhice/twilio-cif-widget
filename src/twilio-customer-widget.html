<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Customer Chat Widget</title>
  <script src="https://media.twiliocdn.com/sdk/js/conversations/v2.4/twilio-conversations.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #0066cc;
      text-align: center;
    }
    .panel {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    #startScreen, #chatScreen {
      display: none;
    }
    #startScreen.active, #chatScreen.active {
      display: block;
    }
    #messages {
      border: 1px solid #ddd;
      height: 400px;
      overflow-y: scroll;
      padding: 15px;
      margin-bottom: 15px;
      background: #fafafa;
      border-radius: 4px;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      background: white;
      border: 1px solid #e0e0e0;
    }
    .message.me {
      background: #e3f2fd;
      border-color: #2196f3;
      margin-left: 40px;
    }
    .message.other {
      background: #f5f5f5;
      margin-right: 40px;
    }
    .message.system {
      background: #e8f5e9;
      border-color: #4caf50;
      text-align: center;
      margin-left: 0;
      margin-right: 0;
      font-size: 13px;
      color: #2e7d32;
    }
    .message .author {
      font-weight: bold;
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .message .body {
      font-size: 14px;
      color: #333;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    input[type="text"], input[type="email"] {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      margin-bottom: 15px;
    }
    button {
      padding: 12px 24px;
      font-size: 14px;
      cursor: pointer;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      width: 100%;
    }
    button:hover {
      background: #0052a3;
    }
    .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      width: auto;
      padding: 5px 10px;
      line-height: 1;
      z-index: 10;
    }
    .close-btn:hover {
      color: #d32f2f;
      background: none;
    }
    .debug-link {
      position: fixed;
      bottom: 10px;
      right: 10px;
      font-size: 11px;
      color: #ccc;
      cursor: pointer;
      text-decoration: underline;
      z-index: 100;
    }
    .debug-link:hover {
      color: #0066cc;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: white;
      padding: 24px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .conversation-item {
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      background: white;
    }
    .conversation-item:hover {
      background: #f5f5f5;
    }
    .info {
      background: #e3f2fd;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 4px;
      border: 1px solid #2196f3;
      font-size: 13px;
    }
    .input-group {
      display: flex;
      gap: 10px;
    }
    .input-group input {
      flex: 1;
      margin-bottom: 0;
    }
    .input-group button {
      width: auto;
      padding: 12px 20px;
    }
  </style>
</head>
<body>
  <h1>ðŸ’¬ Customer Support Chat</h1>

  <div class="panel">
    <!-- Start Screen -->
    <div id="startScreen" class="active">
      <h2>Start a Conversation</h2>
      <p style="color: #666; margin-bottom: 20px;">Connect with a support agent</p>

      <div style="margin-bottom: 15px;">
        <label>Route to Agent:</label>
        <select id="agentSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 1px solid #ddd; border-radius: 4px; margin-top: 4px;">
          <option value="">Loading agents...</option>
        </select>
        <div id="agentLoadError" style="display: none; font-size: 12px; color: #e53935; margin-top: 4px;">
          Could not load agents. Enter identity manually:
          <input type="text" id="agentManualInput" placeholder="e.g. agent123"
            style="display: block; width: 100%; padding: 8px; margin-top: 6px; font-size: 13px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box;">
        </div>
      </div>

      <button onclick="startConversation()">Start Chat</button>
    </div>

    <!-- Chat Screen (populated dynamically by startConversation) -->
    <div id="chatScreen"></div>
  </div>

  <!-- Debug link for testing -->
  <div class="debug-link" onclick="showConversationDashboard()">ðŸ”§ Debug: My Conversations</div>

  <!-- Dashboard Modal -->
  <div id="dashboardModal" class="modal-overlay" style="display: none;">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>My Conversations</h3>
      <div id="conversationList"></div>
      <button onclick="closeDashboard()" style="margin-top: 16px;">Close</button>
    </div>
  </div>

  <script>
    // CONFIGURATION
    const TOKEN_URL = 'https://chattryoutautogeneratedauthservice-6300.twil.io/token';
    const USERS_URL = 'https://chattryoutautogeneratedauthservice-6300.twil.io/users';
    const WEBHOOK_URL = 'YOUR_DYNAMICS_WEBHOOK_URL'; // We'll create this next

    let client;
    let conversation;
    let currentIdentity;
    let customerName; // Store customer's friendly name
    let participantNames = {}; // Store participant friendly names from Twilio

    async function loadAgentsOnPageLoad() {
      const agentSelect = document.getElementById('agentSelect');
      const agentLoadError = document.getElementById('agentLoadError');
      try {
        const response = await fetch(USERS_URL);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        // Filter to agent users (non-customer identities)
        const agents = (data.users || []).filter(u => !u.identity.startsWith('customer_'));

        agentSelect.innerHTML = '';
        if (agents.length === 0) {
          agentSelect.innerHTML = '<option value="">No agents found</option>';
        } else {
          agents.forEach(agent => {
            const option = document.createElement('option');
            option.value = agent.identity;
            option.textContent = agent.friendlyName ? `${agent.friendlyName} (${agent.identity})` : agent.identity;
            agentSelect.appendChild(option);
          });
        }
      } catch (error) {
        console.warn('Could not load agents from Twilio:', error.message);
        agentSelect.style.display = 'none';
        agentLoadError.style.display = 'block';
      }
    }

    async function startConversation() {
      // Determine target agent from dropdown or manual fallback
      const agentSelect = document.getElementById('agentSelect');
      const agentManualInput = document.getElementById('agentManualInput');
      const agentLoadError = document.getElementById('agentLoadError');

      let agentIdentity;
      if (agentLoadError.style.display === 'block') {
        agentIdentity = agentManualInput.value.trim();
      } else {
        agentIdentity = agentSelect.value;
      }

      if (!agentIdentity) {
        alert('Please select or enter an agent to connect to.');
        return;
      }

      // HARDCODED customer for testing
      const name = 'John Doe';
      const email = 'demo@demo.com';

      // Transition to chat screen with loading state
      const startScreen = document.getElementById('startScreen');
      const chatScreen = document.getElementById('chatScreen');
      startScreen.classList.remove('active');
      chatScreen.innerHTML = '<div style="text-align: center; padding: 40px;">Connecting to chat...</div>';
      chatScreen.classList.add('active');

      try {
        currentIdentity = 'customer_demo_demo_com';
        customerName = name;

        console.log('Getting token for:', currentIdentity);

        // Get token
        const tokenResponse = await fetch(`${TOKEN_URL}?identity=${encodeURIComponent(currentIdentity)}`);
        if (!tokenResponse.ok) throw new Error('Failed to get token');
        const tokenData = await tokenResponse.json();

        // Initialize Twilio client
        client = await Twilio.Conversations.Client.create(tokenData.token);
        console.log('Client initialized');

        // Create new conversation
        console.log('Creating new conversation...');
        conversation = await client.createConversation({
          friendlyName: `Support Chat - ${name}`,
          attributes: JSON.stringify({
            customerName: name,
            customerEmail: email,
            createdAt: new Date().toISOString(),
            status: 'new',
            participants: {
              [currentIdentity]: name,
              [agentIdentity]: agentIdentity
            }
          })
        });

        console.log('Conversation created:', conversation.sid);

        // Join the conversation
        await conversation.join();
        console.log('Joined conversation');

        // Add the agent as a participant
        console.log(`Adding agent ${agentIdentity} to conversation...`);
        try {
          await conversation.add(agentIdentity);
          console.log('âœ… Agent added to conversation');
        } catch (error) {
          console.log('Note: Could not add agent (may need to be done server-side):', error.message);
        }

        // Load participant friendly names from Twilio
        await loadParticipantNames();

        // Send notification to Dynamics (webhook)
        await notifyDynamics({
          conversationSid: conversation.sid,
          customerName: name,
          customerEmail: email,
          identity: currentIdentity,
          agentIdentity: agentIdentity
        });

        // Restore full chat UI
        chatScreen.innerHTML = `
          <button class="close-btn" onclick="closeConversation()" title="Close conversation">Ã—</button>
          <div class="info">
            <strong>ðŸ‘¤ Name:</strong> <span id="displayName"></span><br>
            <strong>ðŸ“§ Email:</strong> <span id="displayEmail"></span><br>
            <strong>ðŸ’¬ Conversation ID:</strong> <span id="displayConvSid" style="font-size: 11px;"></span>
          </div>
          <div id="messages"></div>
          <div class="input-group">
            <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
            <button onclick="sendMessage()">Send</button>
          </div>
        `;

        document.getElementById('displayName').textContent = name;
        document.getElementById('displayEmail').textContent = email;
        document.getElementById('displayConvSid').textContent = conversation.sid;

        // Set up message listener
        conversation.on('messageAdded', displayMessage);

        // Send initial message
        await conversation.sendMessage(`Hi, my name is ${name}. I need help.`);

        document.getElementById('messageInput').focus();
        console.log('âœ… Conversation started!');

      } catch (error) {
        console.error('Error:', error);
        chatScreen.classList.remove('active');
        startScreen.classList.add('active');
        alert(`Connection Error: ${error.message}`);
      }
    }

    async function notifyDynamics(data) {
      // Send webhook to Dynamics to notify about new conversation
      try {
        console.log('Notifying Dynamics:', data);
        
        // If you have a webhook URL configured
        if (WEBHOOK_URL && WEBHOOK_URL !== 'YOUR_DYNAMICS_WEBHOOK_URL') {
          await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              eventType: 'newConversation',
              ...data
            })
          });
          console.log('Dynamics notified');
        } else {
          console.log('No webhook URL configured - skipping Dynamics notification');
        }
      } catch (error) {
        console.error('Failed to notify Dynamics:', error);
        // Don't fail the conversation creation if webhook fails
      }
    }

    async function loadParticipantNames() {
      // Load participant friendly names from Twilio User objects
      try {
        const participants = await conversation.getParticipants();

        for (const participant of participants) {
          if (participant.identity) {
            try {
              const user = await participant.getUser();
              if (user && user.friendlyName) {
                participantNames[participant.identity] = user.friendlyName;
                console.log(`Loaded friendly name for ${participant.identity}: ${user.friendlyName}`);
              }
            } catch (userError) {
              console.log(`No user object found for ${participant.identity}`);
            }
          }
        }

        // Also load from conversation attributes as fallback
        if (conversation.attributes) {
          const attrs = JSON.parse(conversation.attributes);
          if (attrs.participants) {
            // Merge attributes with Twilio user data, preferring Twilio user data
            participantNames = { ...attrs.participants, ...participantNames };
          }
        }
      } catch (e) {
        console.error('Error loading participant names:', e);
      }
    }

    function getFriendlyName(author) {
      // First check loaded participant names from Twilio
      if (participantNames[author]) {
        return participantNames[author];
      }

      // Fallback to simple display
      if (author === currentIdentity) {
        return 'You';
      } else if (author.startsWith('agent')) {
        return 'Support Agent';
      } else if (author.startsWith('customer_')) {
        return 'Customer';
      }
      return author;
    }

    function displayMessage(message) {
      const messagesDiv = document.getElementById('messages');
      const msgElement = document.createElement('div');
      msgElement.className = 'message';

      // Check if it's a system message (starts with âœ… or specific patterns)
      const isSystemMessage = message.body.startsWith('âœ…') || message.body.includes('agent has been notified');

      if (isSystemMessage) {
        msgElement.classList.add('system');
        msgElement.innerHTML = `
          <div class="body">${escapeHtml(message.body)}</div>
        `;
      } else {
        if (message.author === currentIdentity) {
          msgElement.classList.add('me');
        } else {
          msgElement.classList.add('other');
        }

        const time = new Date(message.dateCreated).toLocaleTimeString();
        const displayName = getFriendlyName(message.author);

        msgElement.innerHTML = `
          <div class="author">${escapeHtml(displayName)}</div>
          <div class="body">${escapeHtml(message.body)}</div>
          <div style="font-size: 10px; color: #999; margin-top: 5px;">${time}</div>
        `;
      }

      messagesDiv.appendChild(msgElement);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const messageText = input.value.trim();
      
      if (messageText && conversation) {
        try {
          await conversation.sendMessage(messageText);
          input.value = '';
        } catch (error) {
          console.error('Error sending message:', error);
          alert('Error sending message: ' + error.message);
        }
      }
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter') {
        sendMessage();
      }
    }

    async function closeConversation() {
      if (!confirm('Are you sure you want to close this conversation? This cannot be undone.')) {
        return;
      }

      try {
        console.log('Closing conversation...');

        // Send closing message
        await conversation.sendMessage('Customer has closed the conversation.');

        // Leave the conversation
        await conversation.leave();

        // Try to delete the conversation (only works if user has permission)
        try {
          await conversation.delete();
          console.log('âœ… Conversation deleted');
        } catch (e) {
          console.log('Note: Could not delete conversation (may need to be done server-side)');
        }

        // Reset UI
        const chatScreen = document.getElementById('chatScreen');
        const startScreen = document.getElementById('startScreen');

        if (chatScreen) {
          chatScreen.classList.remove('active');
        }

        if (startScreen) {
          startScreen.classList.add('active');
        }

        conversation = null;
        client = null;
        chatScreen.innerHTML = '';

      } catch (error) {
        console.error('Error closing conversation:', error);
        alert('Error closing conversation: ' + error.message);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // DEBUG: Show conversation dashboard
    async function showConversationDashboard() {
      if (!client) {
        alert('Not connected. Please wait for initialization.');
        return;
      }

      const modal = document.getElementById('dashboardModal');
      const listDiv = document.getElementById('conversationList');

      listDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading conversations...</div>';
      modal.style.display = 'flex';

      try {
        const convs = await client.getSubscribedConversations();

        if (convs.items.length === 0) {
          listDiv.innerHTML = '<p>No conversations found.</p>';
          return;
        }

        listDiv.innerHTML = '';
        convs.items.forEach((conv) => {
          const item = document.createElement('div');
          item.className = 'conversation-item';
          item.innerHTML = `
            <strong>${conv.friendlyName || 'Untitled Conversation'}</strong><br>
            <span style="font-size: 11px; color: #999;">${conv.sid}</span>
          `;
          item.onclick = () => rejoinConversation(conv);
          listDiv.appendChild(item);
        });
      } catch (error) {
        console.error('Error loading conversations:', error);
        listDiv.innerHTML = '<p style="color: red;">Error loading conversations</p>';
      }
    }

    function closeDashboard() {
      document.getElementById('dashboardModal').style.display = 'none';
    }

    async function rejoinConversation(conv) {
      try {
        closeDashboard();

        // Clear current messages
        document.getElementById('messages').innerHTML = '';

        // Update conversation reference
        conversation = conv;

        // Load participant names
        await loadParticipantNames();

        // Update UI
        const attrs = conv.attributes
          ? (typeof conv.attributes === 'string' ? JSON.parse(conv.attributes) : conv.attributes)
          : {};
        document.getElementById('displayName').textContent = attrs.customerName || 'Customer';
        document.getElementById('displayEmail').textContent = attrs.customerEmail || 'N/A';
        document.getElementById('displayConvSid').textContent = conv.sid;

        // Load message history
        const messages = await conv.getMessages();
        messages.items.forEach(displayMessage);

        // Set up listener for new messages
        conv.removeAllListeners('messageAdded');
        conv.on('messageAdded', displayMessage);

        console.log('âœ… Rejoined conversation:', conv.sid);
      } catch (error) {
        console.error('Error rejoining conversation:', error);
        alert('Error rejoining conversation: ' + error.message);
      }
    }

    // Load agents into the dropdown on page load
    window.addEventListener('load', loadAgentsOnPageLoad);
  </script>
</body>
</html>