<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Twilio Conversation Manager</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #0066cc;
      text-align: center;
    }
    .panel {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .credentials {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
      color: #333;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 13px;
    }
    button {
      padding: 12px 24px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover {
      background: #0052a3;
    }
    button.danger {
      background: #dc3545;
    }
    button.danger:hover {
      background: #c82333;
    }
    button.success {
      background: #28a745;
    }
    button.success:hover {
      background: #218838;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .conversation-list {
      margin-top: 20px;
    }
    .conversation-item {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 15px;
      align-items: center;
    }
    .conversation-item:hover {
      background: #f9f9f9;
    }
    .conversation-info {
      flex: 1;
    }
    .conversation-sid {
      font-family: monospace;
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    .conversation-name {
      font-weight: bold;
      font-size: 14px;
      margin-bottom: 5px;
    }
    .conversation-meta {
      font-size: 12px;
      color: #999;
    }
    .conversation-actions {
      display: flex;
      gap: 10px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 4px;
      text-align: center;
    }
    .stat-number {
      font-size: 32px;
      font-weight: bold;
      color: #0066cc;
    }
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #ef5350;
    }
    .success {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 15px;
      border-radius: 4px;
      margin: 10px 0;
      border: 1px solid #66bb6a;
    }
    .checkbox {
      margin-right: 5px;
    }
    .bulk-actions {
      background: #fff3cd;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      border: 1px solid #ffc107;
      display: none;
    }
    .bulk-actions.active {
      display: block;
    }
    .filter-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      align-items: center;
    }
    .filter-controls input {
      flex: 1;
    }
  </style>
</head>
<body>
  <h1>üóëÔ∏è Twilio Conversation Manager</h1>

  <!-- Credentials Panel -->
  <div class="panel">
    <h2>Twilio Credentials</h2>
    <div class="credentials">
      <div>
        <label>Account SID:</label>
        <input type="text" id="accountSid" placeholder="AC...">
      </div>
      <div>
        <label>Auth Token:</label>
        <input type="password" id="authToken" placeholder="Your auth token">
      </div>
    </div>
    <button onclick="loadConversations()">Load Conversations</button>
    <button class="success" onclick="toggleAuthToken()">Show/Hide Token</button>
  </div>

  <!-- Stats Panel -->
  <div id="statsPanel" style="display: none;">
    <div class="stats">
      <div class="stat-box">
        <div class="stat-number" id="totalCount">0</div>
        <div class="stat-label">Total Conversations</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="selectedCount">0</div>
        <div class="stat-label">Selected</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="deletedCount">0</div>
        <div class="stat-label">Deleted</div>
      </div>
      <div class="stat-box">
        <div class="stat-number" id="errorCount">0</div>
        <div class="stat-label">Errors</div>
      </div>
    </div>
  </div>

  <!-- Bulk Actions Panel -->
  <div id="bulkActionsPanel" class="bulk-actions">
    <strong>Bulk Actions:</strong>
    <button class="danger" onclick="deleteSelected()">Delete Selected</button>
    <button onclick="selectAll()">Select All</button>
    <button onclick="deselectAll()">Deselect All</button>
  </div>

  <!-- Filter Controls -->
  <div id="filterPanel" style="display: none;">
    <div class="filter-controls">
      <input type="text" id="searchFilter" placeholder="Search by name or SID..." oninput="filterConversations()">
      <button onclick="clearFilter()">Clear</button>
    </div>
  </div>

  <!-- Messages Panel -->
  <div id="messagesPanel"></div>

  <!-- Conversations List -->
  <div class="panel">
    <h2>Conversations</h2>
    <div id="conversationsList">
      <p style="text-align: center; color: #999;">Enter your credentials and click "Load Conversations"</p>
    </div>
  </div>

  <script>
    let conversations = [];
    let allConversations = [];
    let selectedConversations = new Set();
    let stats = {
      total: 0,
      selected: 0,
      deleted: 0,
      errors: 0
    };

    function toggleAuthToken() {
      const input = document.getElementById('authToken');
      input.type = input.type === 'password' ? 'text' : 'password';
    }

    function getCredentials() {
      const accountSid = document.getElementById('accountSid').value.trim();
      const authToken = document.getElementById('authToken').value.trim();
      
      if (!accountSid || !authToken) {
        showMessage('Please enter both Account SID and Auth Token', 'error');
        return null;
      }
      
      return { accountSid, authToken };
    }

    async function loadConversations() {
      const creds = getCredentials();
      if (!creds) return;

      const listDiv = document.getElementById('conversationsList');
      listDiv.innerHTML = '<div class="loading">Loading conversations...</div>';

      try {
        const response = await fetch(
          `https://conversations.twilio.com/v1/Conversations`,
          {
            headers: {
              'Authorization': 'Basic ' + btoa(`${creds.accountSid}:${creds.authToken}`)
            }
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();
        allConversations = data.conversations || [];
        conversations = [...allConversations];
        
        stats.total = conversations.length;
        updateStats();
        
        displayConversations();
        
        document.getElementById('statsPanel').style.display = 'block';
        document.getElementById('filterPanel').style.display = 'block';
        
        showMessage(`‚úÖ Loaded ${conversations.length} conversations`, 'success');

      } catch (error) {
        console.error('Error loading conversations:', error);
        listDiv.innerHTML = '';
        showMessage(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    function displayConversations() {
      const listDiv = document.getElementById('conversationsList');
      
      if (conversations.length === 0) {
        listDiv.innerHTML = '<p style="text-align: center; color: #999;">No conversations found</p>';
        return;
      }

      listDiv.innerHTML = conversations.map(conv => {
        const createdDate = new Date(conv.date_created).toLocaleString();
        const updatedDate = new Date(conv.date_updated).toLocaleString();
        const isSelected = selectedConversations.has(conv.sid);
        
        return `
          <div class="conversation-item" data-sid="${conv.sid}">
            <div class="conversation-info">
              <input type="checkbox" class="checkbox" ${isSelected ? 'checked' : ''} 
                     onchange="toggleSelection('${conv.sid}')">
              <div class="conversation-sid">${conv.sid}</div>
              <div class="conversation-name">${conv.friendly_name || 'Unnamed Conversation'}</div>
              <div class="conversation-meta">
                Created: ${createdDate} | Updated: ${updatedDate} | State: ${conv.state}
              </div>
            </div>
            <div class="conversation-actions">
              <button onclick="viewDetails('${conv.sid}')">View Details</button>
              <button class="danger" onclick="deleteConversation('${conv.sid}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function toggleSelection(sid) {
      if (selectedConversations.has(sid)) {
        selectedConversations.delete(sid);
      } else {
        selectedConversations.add(sid);
      }
      
      stats.selected = selectedConversations.size;
      updateStats();
      
      const bulkPanel = document.getElementById('bulkActionsPanel');
      bulkPanel.classList.toggle('active', selectedConversations.size > 0);
    }

    function selectAll() {
      conversations.forEach(conv => selectedConversations.add(conv.sid));
      stats.selected = selectedConversations.size;
      updateStats();
      displayConversations();
      document.getElementById('bulkActionsPanel').classList.add('active');
    }

    function deselectAll() {
      selectedConversations.clear();
      stats.selected = 0;
      updateStats();
      displayConversations();
      document.getElementById('bulkActionsPanel').classList.remove('active');
    }

    function filterConversations() {
      const searchTerm = document.getElementById('searchFilter').value.toLowerCase();
      
      if (!searchTerm) {
        conversations = [...allConversations];
      } else {
        conversations = allConversations.filter(conv => 
          conv.sid.toLowerCase().includes(searchTerm) ||
          (conv.friendly_name && conv.friendly_name.toLowerCase().includes(searchTerm))
        );
      }
      
      displayConversations();
    }

    function clearFilter() {
      document.getElementById('searchFilter').value = '';
      conversations = [...allConversations];
      displayConversations();
    }

    async function deleteConversation(sid) {
      if (!confirm(`Are you sure you want to delete conversation ${sid}?`)) {
        return;
      }

      const creds = getCredentials();
      if (!creds) return;

      try {
        const response = await fetch(
          `https://conversations.twilio.com/v1/Conversations/${sid}`,
          {
            method: 'DELETE',
            headers: {
              'Authorization': 'Basic ' + btoa(`${creds.accountSid}:${creds.authToken}`)
            }
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        // Remove from local arrays
        allConversations = allConversations.filter(c => c.sid !== sid);
        conversations = conversations.filter(c => c.sid !== sid);
        selectedConversations.delete(sid);
        
        stats.total = allConversations.length;
        stats.selected = selectedConversations.size;
        stats.deleted++;
        updateStats();
        
        displayConversations();
        showMessage(`‚úÖ Deleted conversation ${sid}`, 'success');

      } catch (error) {
        console.error('Error deleting conversation:', error);
        stats.errors++;
        updateStats();
        showMessage(`‚ùå Error deleting ${sid}: ${error.message}`, 'error');
      }
    }

    async function deleteSelected() {
      const count = selectedConversations.size;
      
      if (count === 0) {
        showMessage('No conversations selected', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to delete ${count} conversation(s)?`)) {
        return;
      }

      const creds = getCredentials();
      if (!creds) return;

      showMessage(`Deleting ${count} conversations...`, 'success');

      let successCount = 0;
      let errorCount = 0;

      for (const sid of selectedConversations) {
        try {
          const response = await fetch(
            `https://conversations.twilio.com/v1/Conversations/${sid}`,
            {
              method: 'DELETE',
              headers: {
                'Authorization': 'Basic ' + btoa(`${creds.accountSid}:${creds.authToken}`)
              }
            }
          );

          if (response.ok) {
            successCount++;
            allConversations = allConversations.filter(c => c.sid !== sid);
            conversations = conversations.filter(c => c.sid !== sid);
          } else {
            errorCount++;
          }
        } catch (error) {
          console.error('Error deleting:', sid, error);
          errorCount++;
        }
      }

      selectedConversations.clear();
      stats.total = allConversations.length;
      stats.selected = 0;
      stats.deleted += successCount;
      stats.errors += errorCount;
      updateStats();
      
      displayConversations();
      document.getElementById('bulkActionsPanel').classList.remove('active');
      
      showMessage(`‚úÖ Deleted ${successCount} conversations. ${errorCount > 0 ? `${errorCount} errors.` : ''}`, 'success');
    }

    async function viewDetails(sid) {
      const creds = getCredentials();
      if (!creds) return;

      try {
        const response = await fetch(
          `https://conversations.twilio.com/v1/Conversations/${sid}`,
          {
            headers: {
              'Authorization': 'Basic ' + btoa(`${creds.accountSid}:${creds.authToken}`)
            }
          }
        );

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const conv = await response.json();
        
        alert(`Conversation Details:
        
SID: ${conv.sid}
Friendly Name: ${conv.friendly_name || 'N/A'}
State: ${conv.state}
Created: ${new Date(conv.date_created).toLocaleString()}
Updated: ${new Date(conv.date_updated).toLocaleString()}
Attributes: ${conv.attributes || '{}'}
        `);

      } catch (error) {
        console.error('Error fetching details:', error);
        showMessage(`‚ùå Error: ${error.message}`, 'error');
      }
    }

    function updateStats() {
      document.getElementById('totalCount').textContent = stats.total;
      document.getElementById('selectedCount').textContent = stats.selected;
      document.getElementById('deletedCount').textContent = stats.deleted;
      document.getElementById('errorCount').textContent = stats.errors;
    }

    function showMessage(message, type) {
      const messagesPanel = document.getElementById('messagesPanel');
      const msgDiv = document.createElement('div');
      msgDiv.className = type;
      msgDiv.textContent = message;
      
      messagesPanel.innerHTML = '';
      messagesPanel.appendChild(msgDiv);
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        msgDiv.remove();
      }, 5000);
    }
  </script>
</body>
</html>